import { useState, useEffect, useCallback } from 'react';import { useAuth } from '../contexts/AuthContext';import { useI18n } from '../i18n';import { showToast } from '../components/Toast';import { getPrice, getBalance, getPublicBalance, previewBuy, previewSell, buyToken, sellToken, getTradeConfig } from '../services/blockchain';import { useWriteContract } from 'wagmi';import { parseUnits } from 'viem';import { ArrowDownUp, TrendingUp, Wallet, ArrowRight, Loader2, RefreshCw, CheckCircle, AlertCircle, Plus, Minus } from 'lucide-react';import './Trade.css';const ERC20_ABI = [{ name: 'transfer', type: 'function', stateMutability: 'nonpayable', inputs: [{ name: 'to', type: 'address' }, { name: 'amount', type: 'uint256' }], outputs: [{ type: 'bool' }] }];export default function Trade() {  const { t } = useI18n();  const { walletAddress, token: authToken, refreshUser, authenticate } = useAuth();  const [tab, setTab] = useState('buy');  const [amount, setAmount] = useState('');  const [previewData, setPreviewData] = useState(null);  const [price, setPrice] = useState(null);  const [balance, setBalance] = useState({ try_balance: 0, token_balance: '0' });  const [loading, setLoading] = useState(false);  const [previewLoading, setPreviewLoading] = useState(false);  const [tradeConfig, setTradeConfig] = useState(null);  const [buyStep, setBuyStep] = useState('idle');   const [sellStep, setSellStep] = useState('input');   const fetchData = useCallback(async () => {    try {      const calls = [getPrice(), getTradeConfig()];      if (authToken) {        calls.push(getBalance());      } else if (walletAddress) {        calls.push(getPublicBalance(walletAddress));      }      const results = await Promise.allSettled(calls);      if (results[0].status === 'fulfilled') {        const p = results[0].value.data;        setPrice(p.formatted ?? p.price ?? p);      }      if (results[1].status === 'fulfilled') setTradeConfig(results[1].value.data);      if (results[2]?.status === 'fulfilled') setBalance(results[2].value.data);    } catch {}  }, [authToken, walletAddress]);  useEffect(() => { fetchData(); }, [fetchData]);  useEffect(() => {    if (!amount || isNaN(amount) || Number(amount) <= 0) {      setPreviewData(null);      return;    }    const timer = setTimeout(async () => {      setPreviewLoading(true);      try {        const res = tab === 'buy'          ? await previewBuy(amount)          : await previewSell(amount);        setPreviewData(res.data);      } catch {        setPreviewData(null);      } finally {        setPreviewLoading(false);      }    }, 500);    return () => clearTimeout(timer);  }, [amount, tab]);  const handleBuy = async () => {    if (!amount || Number(amount) <= 0) return;    setLoading(true);    try {      if (!authToken) {        setBuyStep('authing');        await authenticate();      }      setBuyStep('processing');      await buyToken(amount);      setBuyStep('done');      showToast(t('trade.buySuccess'), 'success');      setAmount('');      setPreviewData(null);      await new Promise(r => setTimeout(r, 500));      fetchData();      refreshUser();    } catch (err) {      showToast(err.response?.data?.error || t('error'), 'error');    } finally {      setLoading(false);      setBuyStep('idle');    }  };  const { writeContractAsync } = useWriteContract();  const handleSell = async () => {    if (!amount || Number(amount) <= 0 || !tradeConfig) return;    setLoading(true);    setSellStep('confirming');    try {      if (!authToken) {        await authenticate();      }      const decimals = tradeConfig.tokenDecimals || 18;      const parsedAmount = parseUnits(amount.toString(), decimals);      const hash = await writeContractAsync({        address: tradeConfig.tokenAddress,        abi: ERC20_ABI,        functionName: 'transfer',        args: [tradeConfig.poolAddress || tradeConfig.adminAddress, parsedAmount],      });      setSellStep('verifying');      await sellToken(hash);      showToast(t('trade.sellSuccess'), 'success');      setAmount('');      setPreviewData(null);      await new Promise(r => setTimeout(r, 500));      fetchData();      refreshUser();    } catch (err) {      const msg = err?.shortMessage || err?.response?.data?.error || err?.message || t('error');      showToast(msg, 'error');    } finally {      setLoading(false);      setSellStep('input');    }  };  const setMaxAmount = () => {    if (tab === 'buy') {      if (price && balance.try_balance) {        setAmount(String(Math.floor((balance.try_balance / price) * 100) / 100));      }    } else {      setAmount(balance.token_balance || '0');    }  };  return (    <div className="trade-page">      <div className="container">        {}        <div className="trade-info-grid animate-fadeIn">          <div className="info-card">            <div className="info-icon price-icon"><TrendingUp size={20} /></div>            <div>              <div className="info-label">{t('trade.currentPrice')}</div>              <div className="info-value">{price ?? '—'} <span className="info-unit">TRY</span></div>            </div>          </div>          <div className="info-card">            <div className="info-icon try-icon"><Wallet size={20} /></div>            <div>              <div className="info-label">{t('trade.tryBalance')}</div>              <div className="info-value">{Number(balance.try_balance || 0).toLocaleString()} <span className="info-unit">TRY</span></div>            </div>          </div>          <div className="info-card">            <div className="info-icon token-icon"><ArrowDownUp size={20} /></div>            <div>              <div className="info-label">{t('trade.tokenBalance')}</div>              <div className="info-value">{Number(balance.token_balance || 0).toLocaleString()} <span className="info-unit">MRT</span></div>            </div>          </div>          <div className="info-card wallet-card">            {walletAddress ? (              <div className="wallet-status connected">                <CheckCircle size={16} />                <span className="wallet-addr">{walletAddress.slice(0, 6)}...{walletAddress.slice(-4)}</span>              </div>            ) : (              <div className="wallet-status">                <AlertCircle size={16} />                <span>{t('trade.walletRequired')}</span>              </div>            )}          </div>        </div>        {}        <div className="trade-card animate-fadeInUp delay-100">          {}          <div className="trade-tabs">            <button className={`trade-tab ${tab === 'buy' ? 'active buy' : ''}`} onClick={() => { setTab('buy'); setAmount(''); setPreviewData(null); }}>              {t('trade.buy')} MRT            </button>            <button className={`trade-tab ${tab === 'sell' ? 'active sell' : ''}`} onClick={() => { setTab('sell'); setAmount(''); setPreviewData(null); }}>              {t('trade.sell')} MRT            </button>          </div>          <div className="trade-body">            {tab === 'buy' ? (              <>                <div className="form-group">                  <div className="form-label-row">                    <label className="form-label">{t('trade.tokenAmount')}</label>                    <button className="max-btn" onClick={setMaxAmount}>{t('trade.maxAmount')}</button>                  </div>                  {}                  <div className="amount-stepper">                    <button                      className="stepper-btn stepper-minus"                      onClick={() => setAmount(String(Math.max(0, (Number(amount) || 0) - 1)))}                      disabled={!amount || Number(amount) <= 0}                    >                      <Minus size={20} />                    </button>                    <div className="stepper-display">                      <input                        type="text"                        inputMode="decimal"                        className="stepper-input"                        value={amount}                        onChange={(e) => {                          const v = e.target.value;                          if (v === '' || /^\d*\.?\d*$/.test(v)) setAmount(v);                        }}                        placeholder="0"                      />                      <span className="stepper-unit">MRT</span>                    </div>                    <button                      className="stepper-btn stepper-plus"                      onClick={() => setAmount(String((Number(amount) || 0) + 1))}                    >                      <Plus size={20} />                    </button>                  </div>                  {}                  <div className="amount-presets">                    {[1, 5, 10, 50, 100].map((v) => (                      <button                        key={v}                        className={`preset-chip ${Number(amount) === v ? 'active' : ''}`}                        onClick={() => setAmount(String(v))}                      >                        {v}                      </button>                    ))}                  </div>                  {}                  {amount && Number(amount) > 0 && price && (                    <div className="cost-hint">                      <span>≈ {(Number(amount) * price).toLocaleString()} TRY</span>                    </div>                  )}                </div>                {}                {previewLoading && <div className="preview-loading"><Loader2 size={16} className="animate-spin" /> {t('trade.preview')}...</div>}                {previewData && !previewLoading && (                  <div className="preview-card">                    <div className="preview-row">                      <span>{t('trade.youPay')}</span>                      <span className="preview-value">{previewData.try_cost ?? previewData.tryNeeded ?? (Number(amount) * price).toLocaleString()} TRY</span>                    </div>                    <div className="preview-row">                      <span>{t('trade.youReceive')}</span>                      <span className="preview-value highlight">{previewData.token_amount ?? amount} MRT</span>                    </div>                    <div className="preview-row">                      <span>{t('trade.price')}</span>                      <span className="preview-value">{price} TRY/MRT</span>                    </div>                  </div>                )}                {}                {loading && (                  <div className="sell-steps">                    {!authToken && (                      <div className={`sell-step ${buyStep === 'authing' ? 'active' : buyStep === 'processing' || buyStep === 'done' ? 'done' : ''}`}>                        <span className="step-num">1</span>                        <span>İmza Doğrulama</span>                      </div>                    )}                    <div className={`sell-step ${buyStep === 'processing' ? 'active' : buyStep === 'done' ? 'done' : ''}`}>                      <span className="step-num">{authToken ? '1' : '2'}</span>                      <span>Token Aktarımı</span>                    </div>                  </div>                )}                <button className="btn btn-primary btn-full trade-submit" onClick={handleBuy} disabled={loading || !amount || !walletAddress}>                  {loading ? <Loader2 size={18} className="animate-spin" /> : <ArrowRight size={18} />}                  {buyStep === 'authing' ? 'İmza Bekleniyor...' : buyStep === 'processing' ? 'İşleniyor...' : authToken ? t('trade.confirmBuy') : 'İmza ile Doğrulama Yap'}                </button>              </>            ) : (              <>                <div className="form-group">                  <div className="form-label-row">                    <label className="form-label">{t('trade.tokenAmount')}</label>                    <button className="max-btn" onClick={setMaxAmount}>{t('trade.maxAmount')}</button>                  </div>                  {}                  <div className="amount-stepper sell-stepper">                    <button                      className="stepper-btn stepper-minus"                      onClick={() => setAmount(String(Math.max(0, (Number(amount) || 0) - 1)))}                      disabled={!amount || Number(amount) <= 0}                    >                      <Minus size={20} />                    </button>                    <div className="stepper-display">                      <input                        type="text"                        inputMode="decimal"                        className="stepper-input"                        value={amount}                        onChange={(e) => {                          const v = e.target.value;                          if (v === '' || /^\d*\.?\d*$/.test(v)) setAmount(v);                        }}                        placeholder="0"                      />                      <span className="stepper-unit sell">MRT</span>                    </div>                    <button                      className="stepper-btn stepper-plus"                      onClick={() => setAmount(String((Number(amount) || 0) + 1))}                    >                      <Plus size={20} />                    </button>                  </div>                  {}                  <div className="amount-presets">                    {[1, 5, 10, 50, 100].map((v) => (                      <button                        key={v}                        className={`preset-chip ${Number(amount) === v ? 'active sell' : ''}`}                        onClick={() => setAmount(String(v))}                      >                        {v}                      </button>                    ))}                  </div>                  {}                  {amount && Number(amount) > 0 && price && (                    <div className="cost-hint earn-hint">                      <span>≈ {(Number(amount) * price).toLocaleString()} TRY kazanırsınız</span>                    </div>                  )}                </div>                {}                {previewLoading && <div className="preview-loading"><Loader2 size={16} className="animate-spin" /> {t('trade.preview')}...</div>}                {previewData && !previewLoading && (                  <div className="preview-card sell-preview">                    <div className="preview-row">                      <span>Satacağınız</span>                      <span className="preview-value">{previewData.token_amount ?? amount} MRT</span>                    </div>                    <div className="preview-row">                      <span>Alacağınız</span>                      <span className="preview-value highlight">{previewData.try_earned ?? (Number(amount) * price).toFixed(2)} TRY</span>                    </div>                    <div className="preview-row">                      <span>{t('trade.price')}</span>                      <span className="preview-value">{price} TRY/MRT</span>                    </div>                  </div>                )}                {}                {loading && (                  <div className="sell-steps">                    <div className={`sell-step ${sellStep === 'confirming' ? 'active' : sellStep === 'verifying' ? 'done' : ''}`}>                      <span className="step-num">1</span>                      <span>MetaMask Onayı</span>                    </div>                    <div className={`sell-step ${sellStep === 'verifying' ? 'active' : ''}`}>                      <span className="step-num">2</span>                      <span>İşlem Doğrulama</span>                    </div>                  </div>                )}                <button className="btn btn-primary btn-full trade-submit sell" onClick={handleSell} disabled={loading || !amount || Number(amount) <= 0 || !walletAddress}>                  {loading ? <Loader2 size={18} className="animate-spin" /> : <ArrowRight size={18} />}                  {sellStep === 'confirming' ? 'MetaMask Onayı Bekleniyor...' : sellStep === 'verifying' ? 'Doğrulanıyor...' : authToken ? t('trade.confirmSell') : 'İmza ile Doğrulama Yap'}                </button>              </>            )}            {!walletAddress && (              <div className="trade-warning">                <AlertCircle size={16} />                {t('trade.walletRequired')}              </div>            )}          </div>        </div>        {}        <div className="trade-refresh">          <button className="btn btn-ghost btn-sm" onClick={fetchData}>            <RefreshCw size={14} /> {t('loading').replace('...', '')}          </button>        </div>      </div>    </div>  );}